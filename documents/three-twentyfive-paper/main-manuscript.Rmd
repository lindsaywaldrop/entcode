---
title: "Three and twenty-five hair array paper"
author: "L.D. Waldrop, S. Khatri, Y. He"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    number_sections: true
    toc: false
    keep_tex: yes
    latex_engine: xelatex
    citation_package: natbib
bibliography: references.bib
csl: oxford-university-press-scimed-author-date.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
save_figs <- F
save_results <- F
```
```{r data-input, include=FALSE}
library(tidyr) # for various data cleaning operations
library(ggplot2) # for ggplots
library(patchwork) # for creating paneled figures
library(viridis) # for the viridis color palette
library(colorspace) # for scale_color_binned_divergingx

# Sourcing data handling functions
source("./src/r-scripts/datahandling_functions.R")
dir.create("./results/plots", showWarnings = FALSE)

#### Initial values ####
hdia <- 0.002     # Diameter of hair

#### Load Flow Data ####
three_hair_flow <- read.csv("./results/r-csv-files/3hair_results/flowdata_2022-11-11.csv")
twofive_hair_flow <- read.csv("./results/r-csv-files/25hair_results/flowdata_2023-06-28.csv", row.names = 1)
#### Load Odor Capture Data ####
three_hair_odor <- read.csv("./results/r-csv-files/3hair_results/totalconc_3hairs_2023-12-12_cleaned.csv", 
                      skip = 0, header = T, row.names = 1)
three_hair_odor <- three_hair_odor[order(three_hair_odor$simulation_number), ]
twofive_hair_odor <- read.csv("./results/r-csv-files/25hair_results/totalconc_25hairs_2023-12-12_cleaned.csv", 
                        skip = 0, header = T, row.names = 1)
twofive_hair_odor <- twofive_hair_odor[order(twofive_hair_odor$simulation_number), ]
#### Combine data sets ####
three_hair <- cbind(three_hair_odor[, 1:14], # parameter list
                    three_hair_flow[, 9:18], # flow data
                    three_hair_odor[, 15:ncol(three_hair_odor)])
twofive_hair <- cbind(twofive_hair_odor[, 1:14], # parameter list
                      twofive_hair_flow[, 10:89], 
                      twofive_hair_odor[, 15:ncol(twofive_hair_odor)])

rm(three_hair_flow, three_hair_odor, twofive_hair_flow, twofive_hair_odor)

# Remove Inf values
twofive_hair$total_conc_ratio <-three_hair$total_conc / twofive_hair$total_conc
twofive_hair$total_conc_ratio[which(is.infinite(twofive_hair$total_conc_ratio))] <- NA
twofive_hair$norm_conc_ratio <- three_hair$norm_conc / twofive_hair$norm_conc
twofive_hair$norm_conc_ratio[which(is.infinite(twofive_hair$norm_conc_ratio))] <- NA

#### Load SI files ####
three_SI <- read.csv("./results/uq-files/3-hair-array-SI_2023-12-21.csv")
twofive_SI <- read.csv("./results/uq-files/25-hair-array-SI_2023-12-21.csv")

three_SI$array <- 3
twofive_SI$array <- 25

SI_data <- pivot_longer(rbind(three_SI, twofive_SI), 
                        cols = !c(output,array), 
                        names_to = "parameter")
SI_data$parameter <- factor(SI_data$parameter, ordered = T, 
                            levels = c("angle", "gap", "ant", "dist", "re", 
                                       "diff_coef", "stink_width", "init_conc"))
SI_data$array <- factor(SI_data$array)
```

```{r define-fxns, include=FALSE}
#### Define plotting functions ####

plot_individual_hairs_fixed <- function(i, three_hair, twofive_hair){
  three_hair_0 <- read.csv("./data/csv-files/3hair_files/hairs0.csv")
  three_hair_0 <- data.frame(t(three_hair_0[, -1]))
  colnames(three_hair_0) <- c("points", "x", "y")
  twofive_hair_0 <- read.csv("./data/csv-files/25hair_files/hairs0.csv")
  twofive_hair_0 <- data.frame(t(twofive_hair_0[, -1]))
  colnames(twofive_hair_0) <- c("points", "x", "y")
  ant <- circle(c(0,0), 0.007, 0.005, F)
  
  row_nums_3 <- which(grepl("^hair[0-9]", colnames(three_hair)))
  row_nums_25 <- which(grepl("^hair[0-9]", colnames(twofive_hair)))
  plot_col_3hairs <- data.frame(three_hair_0, 
                               "value" = as.numeric(t(three_hair[i, row_nums_3])))
  plot_col_3hairs$value <- plot_col_3hairs$value / max(plot_col_3hairs$value)
  plot_col_25hairs <- data.frame(twofive_hair_0, 
                               "value" = as.numeric(t(twofive_hair[i, row_nums_25])))
  plot_col_25hairs$value <- plot_col_25hairs$value / max(plot_col_25hairs$value)
  
  p3<- ggplot(plot_col_3hairs, aes(x, y, color = value, size = value)) + 
    geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0, 1))+
    scale_size_binned("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0, 1), range = c(0.25, 5)) + 
    xlim(min(ant$x), 0.02) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color= guide_legend(), size=guide_legend(), fill = NULL) 
    
  p25<- ggplot(plot_col_25hairs, aes(x,y, color = value, size = value)) + geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0, 1))+
    scale_size_binned("Relative\nconcentration",breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0, 1), range = c(0.25, 5)) + 
    xlim(min(ant$x), 0.08) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color = guide_legend(), size = guide_legend(), fill = NULL) 
  return(p3 + p25 + plot_layout(guides = "collect") & theme(legend.position = 'bottom'))
}

plot_individual_hairs <- function(i, three_hair, twofive_hair, hdia){
  three_hair_0 <- read.csv(paste0("./data/csv-files/3hair_files/hairs",i,".csv"))
  three_hair_0 <- data.frame(t(three_hair_0[, -1]))
  colnames(three_hair_0) <- c("points", "x", "y")
  twofive_hair_0 <- read.csv(paste0("./data/csv-files/25hair_files/hairs",i,".csv"))
  twofive_hair_0 <- data.frame(t(twofive_hair_0[, -1]))
  colnames(twofive_hair_0) <- c("points", "x", "y")
  ant <- circle(c(0, 0), 0.5 * hdia * twofive_hair$ant[i], 0.005, F)
  
  row_nums_3 <- which(grepl("^hair[0-9]", colnames(three_hair)))
  row_nums_25 <- which(grepl("^hair[0-9]", colnames(twofive_hair)))
  plot_col_3hairs <- data.frame(three_hair_0, 
                               "value" = as.numeric(t(three_hair[i, row_nums_3])))
  plot_col_3hairs$value <- plot_col_3hairs$value / max(plot_col_3hairs$value)
  plot_col_25hairs <- data.frame(twofive_hair_0, 
                               "value" = as.numeric(t(twofive_hair[i, row_nums_25])))
  plot_col_25hairs$value <- plot_col_25hairs$value / max(plot_col_25hairs$value)
  
  p3<- ggplot(plot_col_3hairs, aes(x, y, color = value)) + 
    geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0, 1))+
    #scale_size_binned("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
    #                    limits = c(0,1), range = c(0.25, 5)) + 
   # xlim(min(ant$x), 0.02) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color = guide_legend(), size = guide_legend(), fill = NULL) 
    
  p25<- ggplot(plot_col_25hairs, aes(x,y, color = value)) + geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1))+
    #scale_size_binned("Relative\nconcentration",breaks = c(0.2, 0.4, 0.6, 0.8), 
    #                    limits = c(0,1), range = c(0.25, 5)) + 
   # xlim(min(ant$x), 0.08) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color= guide_legend(), size=guide_legend(), fill = NULL) 
  return(p3 + p25 + plot_layout(guides = "collect") & theme(legend.position = 'bottom'))
}

plot_parameter <- function(three_dat, twofive_dat, parameter, output, 
                           equal_yaxis = NULL, col_opt=NULL){
  if(is.null(col_opt)){
    p3 <- ggplot(three_dat, aes(.data[[parameter]], .data[[output]])) + 
      geom_point() +
    ggtitle("3 hair") + theme_minimal()
    p25 <- ggplot(twofive_dat, aes(.data[[parameter]], .data[[output]])) + 
      geom_point() + 
      ylab(" ")+
    ggtitle("25 hair") + theme_minimal()
  }else{
    p3 <- ggplot(three_dat, aes(.data[[parameter]], .data[[output]], 
                              color = .data[[col_opt]])) + 
    geom_point() +
    scale_color_viridis(discrete = F) +
      ylab(" ")+
    ggtitle("3 hair") + theme_minimal()
    p25 <- ggplot(twofive_dat, aes(.data[[parameter]], .data[[output]], 
                              color = .data[[col_opt]])) + 
    geom_point() +
    scale_color_viridis(discrete = F) +
    ggtitle("25 hair") + theme_minimal()
  }
  if(equal_yaxis) {
      yrange <- range(c(three_dat[[output]], twofive_dat[[output]]))
      p3 <- p3 + ylim(yrange)
      p25 <- p25 + ylim(yrange)
    }
  return(p3 + p25)
}

plot_values <- function(dat, variable, output, legend = TRUE){
  col_list <- grep(paste0("^", output), colnames(dat))
  col_list <- c(1:6, col_list)
  dat_sub <- dat[, col_list]
  dat_longer <- pivot_longer(dat_sub, cols = !c(1:6), names_prefix = 
                               output)
  dat_longer$name <- factor(dat_longer$name)
  num <- nlevels(dat_longer$name)
  dat_longer$name <- factor(dat_longer$name, ordered = T, levels = seq(1, num))
  p1<- ggplot(dat_longer, aes(.data[[variable]], value, fill = name,  
                              color = name)) + 
    geom_point(pch = 21, alpha = 0.5) + 
    scale_fill_viridis(discrete = T, name = "") + 
    scale_color_viridis(discrete = T, name = "") +
    ylab(output) + theme_minimal()
  if(!legend){
    p1 <- p1 + theme(legend.position = "none")
  }
  return(p1)
}
```

# Abstract


# Introduction

@Waldrop:entmodel

# Methods


# Results

## Gap-to-diameter ratio is most important for leakiness 

```{r leakiness-gap, echo=FALSE, fig.cap="Leakiness - Gap width"}
plot_values(three_hair, "gap", "leakiness_row_", legend = F) +
plot_values(twofive_hair, "gap", "leakiness_row_")
```

This is true regardless of which row for the 25 hair array. Indicated by SI's. Fig. \@ref(fig:gap-width).

Reynolds number doesn't have much of an effect (Fig. \@ref(fig:re)).

```{r leakiness-re, echo=FALSE, fig.cap= "Leakiness - Reynolds number"}
plot_values(three_hair, "re", "leakiness_row_", legend = F) +
plot_values(twofive_hair, "re", "leakiness_row_")
```

### Moderate angles force more fluid through the first row than whould be there otherwise

```{r leakiness-angle, echo=FALSE, fig.cap= "Leakiness angle"}
plot_values(three_hair, "angle", "leakiness_row_", legend = F) +
plot_values(twofive_hair, "angle", "leakiness_row_")
```


## Speeds around hairs is dependent on angle for most hairs, Re for some

```{r speeds-angle, echo=FALSE, fig.cap="Angle"}
plot_values(three_hair, "angle", "Umean_hair_") +
     plot_values(twofive_hair, "angle", "Umean_hair_")
```

```{r speeds-re, echo=FALSE, fig.cap="Re"}
plot_values(three_hair, "re", "Umean_hair_") +
plot_values(twofive_hair, "re", "Umean_hair_")
```

Re is important for almost all hairs in both arrays, but relatively more important as the hairs are closer to oncoming flow (or on the outer edges of the array). As hairs are located more inside the array, angle of the array becomes more important for driving quicker flows around the hairs. Extreme case is hair 1 (center hair in row 1) at an angle of  90$^{\circ}$) where fluid is being forced between the array and the antenna.

## Concentration capture 


### 25-hair arrays capture more odor


Capture by both arrays depends on gap width. The effect is weaker for the 3-hair array on total concentration and the effect is much stronger for normalized odor capture. 

Angle is the second most important feature to capture, controlling total odor capture for the 3-hair array and strongly influencing normalized capture. It is less important for the 25 hair array. 

```{r total-conc-angle, echo = FALSE, fig.cap="Total concentration and gap width"}
p1 <- plot_parameter(three_hair, twofive_hair, "angle", "norm_conc", equal_yaxis = TRUE,
                 col_opt = "gap") 
p2 <- plot_parameter(three_hair, twofive_hair, "re", "norm_conc", equal_yaxis = TRUE,
                 col_opt = "gap") 
p3 <- ggplot(SI_data[SI_data$output == "norm_conc",], aes(x = parameter, y = value, 
                                                          fill = array)) +
  geom_bar(position = "dodge", stat= "identity") +
  ylab("Sobol index") + xlab(" ") + 
  theme_minimal()
 (p1 / p2 + plot_layout(guides = "collect")) / p3 
```

On average, the 25-hair array captures 2 times more total odor than the 3-hair array. The highest capture rates are at low gap widths, where 25 hairs capture up to 6.8 times more odorant concentration. 

There are some configurations in which 3-hair arrays outperform 25-hair arrays, particularly at extreme array angles and large gap widths. For total concentration captured, 3-hair arrays capture more for large gap widths ($>30$) at angles near 0 or 180 degrees. For normalized capture, the largest differences are around 90 degrees at gap widths over 25. 

```{r concentration-ratios, echo=FALSE, warning=FALSE, fig.cap=" "}
diverging_hcl(n = 3, h = c(260, 0), c = 80, l = c(30, 90), power = 1.5, register= "ratio-palette")
pnorm.ratio <- ggplot(twofive_hair[order(twofive_hair$norm_conc_ratio),], 
                      aes(x = .data[["gap"]], y = .data[["angle"]], 
                          color = .data[["norm_conc_ratio"]], 
                          size = .data[["norm_conc_ratio"]])) + 
  geom_point()+
  scale_color_continuous_diverging(name = "3/25 ratio", mid = 1.0, 
                                   breaks = c(0.5, 1, 1.5), 
                                   palette = "ratio-palette", 
                                   n_interp = 3)+
  scale_size_binned("3/25 ratio", breaks = c(0.5, 1, 1.5), 
                    limits = c(0.1, 6)) + 
  ylab("Angle to oncoming flow (deg)") + xlab("Gap-to-diameter ratio") + 
  ggtitle("Normalized concentration 3/25 ratio") + 
  theme_minimal() + 
  guides(color = guide_legend(), size = guide_legend()) 

pnorm.ratio
if(save_figs) ggsave("./results/plots/ratio-gap-angle-plots.pdf", height = 5, width = 7)
```

Other parameters including the relative antennule width, distance of the array from the antennule, the initial width of the odor filament had little effect on the amount of odor captured by either array. 


It looks like lower gaps lead to less leakiness, which leads to greater odor capture. 

```{r gap-angle-total-conc-map, echo = FALSE, fig.height=5*1.5, fig.width=5}
p3 <- ggplot(three_hair[order(three_hair$norm_conc),], 
             aes(.data[["gap"]], .data[["angle"]], 
                 color = .data[["norm_conc"]], 
                 size = .data[["norm_conc"]])) + 
  geom_point() +
  scale_color_viridis_b("Normalized\nconcentration", 
                        breaks = seq(0, 0.003, length.out = 5), 
                        limits = c(0, 0.003)) +
  scale_size_binned("Normalized\nconcentration", 
                    breaks = seq(0, 0.003, length.out = 5), 
                    range = c(0.5, 4), limits = c(0, 0.003)) + 
  ylab("Angle to oncoming flow (deg)") + xlab("Gap-to-diameter ratio") + 
  ggtitle("3-hair array") + theme_minimal() +
  guides(color= guide_legend(), size=guide_legend()) 


p25 <- ggplot(twofive_hair[order(twofive_hair$norm_conc),], 
              aes(.data[["gap"]], .data[["angle"]], 
              color = .data[["norm_conc"]], 
              size = .data[["norm_conc"]])) + 
  geom_point() +
  scale_color_viridis_b("Normalized\nconcentration", 
                        breaks = seq(0, 0.015, length.out = 5), 
                        limits = c(0, 0.015)) +
  scale_size_binned("Normalized\nconcentration", 
                    breaks = seq(0, 0.015, length.out = 5), 
                    range = c(0.5, 4), limits = c(0, 0.015)) + 
  ylab("Angle to oncoming flow (deg)") + xlab("Gap-to-diameter ratio") + 
  ggtitle("25-hair array") + 
  theme_minimal() + 
  guides(color= guide_legend(), size=guide_legend()) 

(p3 / p25) 
```





```{r max-25-array, echo=FALSE, warning=FALSE, message= FALSE, fig.cap="Parameter combinations for normalized concentration captured for the 3-hair (A, C) and 25-hair arrays (B, D). A,B: parameter combination leading to the maximum capture for the 3-hair array (angle = 90.9, gap = 1.28, ant = 1.36, dist = 0.016, Re = 4.84); C,D: parameter combination for the maximum capture for the 25-hair array (angle = 68.8, gap = 1.19, ant = 30.2, dist = 0.00926, Re = 9.37)."}

plot_individual_hairs(1061, three_hair, twofive_hair, hdia) /

  plot_individual_hairs(876, three_hair, twofive_hair, hdia) +
  plot_annotation(tag_levels = "A") + plot_layout(guides = "collect")
```

```{r gap-angle-water-air-map, echo = FALSE, fig.height=5*1.5, fig.width=5}
three_hair_water <- three_hair[three_hair$diff_coef < 1e-6 &
                                 three_hair$stink_width < 0.03 & 
                                 three_hair$init_conc > 5e6, ]
p3_water_1 <- ggplot(three_hair_water[order(three_hair_water$norm_conc),], 
             aes(.data[["angle"]], .data[["re"]], 
                 color = .data[["norm_conc"]], 
                 size = .data[["norm_conc"]])) + 
  geom_point() +
  scale_color_viridis_b("Normalized\nconcentration", 
                        breaks = seq(0, 0.003, length.out = 5), 
                        limits = c(0, 0.003)) +
  scale_size_binned("Normalized\nconcentration", 
                    breaks = seq(0, 0.003, length.out = 5), 
                    range = c(0.5, 4), limits = c(0, 0.003)) + 
  ylab("Reynolds number") + xlab("Angle to oncoming flow (deg)") + 
  ggtitle("3-hair array") + theme_minimal() +
  guides(color= guide_legend(), size=guide_legend()) 

p3_water_2 <- ggplot(three_hair_water[order(three_hair_water$norm_conc),], 
             aes(.data[["gap"]], .data[["angle"]], 
                 color = .data[["norm_conc"]], 
                 size = .data[["norm_conc"]])) + 
  geom_point() +
  scale_color_viridis_b("Normalized\nconcentration", 
                        breaks = seq(0, 0.003, length.out = 5), 
                        limits = c(0, 0.003)) +
  scale_size_binned("Normalized\nconcentration", 
                    breaks = seq(0, 0.003, length.out = 5), 
                    range = c(0.5, 4), limits = c(0, 0.003)) + 
  ylab("Angle to oncoming flow (deg)") + xlab("Gap-to-diameter ratio") + 
  ggtitle("3-hair array") + theme_minimal() +
  guides(color= guide_legend(), size=guide_legend()) 

three_hair_air <- three_hair[three_hair$diff_coef > 7.5e-5 &
                                 three_hair$stink_width > 0.045,]
p3_air <- ggplot(three_hair_air[order(three_hair_air$norm_conc),], 
              aes(.data[["gap"]], .data[["angle"]], 
              color = .data[["norm_conc"]], 
              size = .data[["norm_conc"]])) + 
  geom_point() +
  scale_color_viridis_b("Normalized\nconcentration", 
                        breaks = seq(0, 0.015, length.out = 5), 
                        limits = c(0, 0.015)) +
  scale_size_binned("Normalized\nconcentration", 
                    breaks = seq(0, 0.015, length.out = 5), 
                    range = c(0.5, 4), limits = c(0, 0.015)) + 
  ylab("Angle to oncoming flow (deg)") + xlab("Gap-to-diameter ratio") + 
  ggtitle("25-hair array") + 
  theme_minimal() + 
  guides(color= guide_legend(), size=guide_legend()) 

(p3_water_1 + p3_water_2 +plot_layout(guides = "collect"))/ p3_air
```

# Discussion


# Conclusions


# References

