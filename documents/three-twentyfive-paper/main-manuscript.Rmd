---
title: "Three and twenty-five hair array paper"
author: "L.D. Waldrop, S. Khatri, Y. He"
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2:
    number_sections: true
    toc: false
bibliography: references.bib
csl: oxford-university-press-scimed-author-date.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r data-input, include=FALSE}
library(tidyr) # for various data cleaning operations
library(ggplot2) # for ggplots
library(patchwork) # for creating paneled figures
library(viridis) # for the viridis color palette

# Sourcing data handling functions
source("./src/r-scripts/datahandling_functions.R")

#### Initial values ####
hdia <- 0.002     # Diameter of hair

#### Load data ####
three_hair_flow <- read.csv("./results/r-csv-files/3hair_results/flowdata_2022-11-11.csv")
twofive_hair_flow <- read.csv("./results/r-csv-files/25hair_results/flowdata_2023-06-28.csv", row.names = 1)

three_hair_odor <- read.csv("./results/r-csv-files/3hair_results/totalconc_3hairs_2023-06-27_cleaned.csv", 
                      skip = 0, header = T, row.names = 1)
three_hair_odor <- three_hair_odor[order(three_hair_odor$simulation_number),]
twofive_hair_odor <- read.csv("./results/r-csv-files/25hair_results/totalconc_25hairs_2023-06-26_cleaned.csv", 
                        skip = 0, header = T, row.names = 1)
twofive_hair_odor <- twofive_hair_odor[order(twofive_hair_odor$simulation_number),]
#### Combine data sets ####
three_hair <- cbind(three_hair_odor[,1:9], # parameter list
                    three_hair_flow[,9:18], # flow data
                    three_hair_odor[,10:15])
twofive_hair <- cbind(twofive_hair_odor[,1:9], # parameter list
                      twofive_hair_flow[,10:89],
                      twofive_hair_odor[,10:41])

rm(three_hair_flow, three_hair_odor, twofive_hair_flow, twofive_hair_odor)

row_nums_3 <- which(grepl("^hair",colnames(three_hair)))
three_hair$raw_total_conc <- apply(three_hair[,row_nums_3],1,sum)
row_nums_25 <- which(grepl("^hair",colnames(twofive_hair)))
twofive_hair$raw_total_conc <- apply(twofive_hair[, row_nums_25], 1, sum)

#### Define plotting functions ####

plot_individual_hairs_fixed <- function(i, three_hair, twofive_hair){
  three_hair_0 <- read.csv("./data/csv-files/3hair_files/hairs0.csv")
  three_hair_0 <- data.frame(t(three_hair_0[,-1]))
  colnames(three_hair_0) <- c("points", "x", "y")
  twofive_hair_0 <- read.csv("./data/csv-files/25hair_files/hairs0.csv")
  twofive_hair_0 <- data.frame(t(twofive_hair_0[,-1]))
  colnames(twofive_hair_0) <- c("points", "x", "y")
  ant <- circle(c(0,0), 0.007, 0.005, F)
  
  row_nums_3 <- which(grepl("^hair",colnames(three_hair)))
  row_nums_25 <- which(grepl("^hair",colnames(twofive_hair)))
  plot_col_3hairs <- data.frame(three_hair_0, 
                               "value" = as.numeric(t(three_hair[i, row_nums_3])))
  plot_col_3hairs$value <- plot_col_3hairs$value/max(plot_col_3hairs$value)
  plot_col_25hairs <- data.frame(twofive_hair_0, 
                               "value" = as.numeric(t(twofive_hair[i, row_nums_25])))
  plot_col_25hairs$value <- plot_col_25hairs$value/max(plot_col_25hairs$value)
  
  p3<- ggplot(plot_col_3hairs, aes(x,y, color = value, size = value)) + 
    geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1))+
    scale_size_binned("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1), range = c(0.25, 5)) + 
    xlim(min(ant$x), 0.02) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color= guide_legend(), size=guide_legend(), fill = NULL) 
    
  p25<- ggplot(plot_col_25hairs, aes(x,y, color = value, size = value)) + geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1))+
    scale_size_binned("Relative\nconcentration",breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1), range = c(0.25, 5)) + 
    xlim(min(ant$x), 0.08) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color= guide_legend(), size=guide_legend(), fill = NULL) 
  return(p3 + p25 + plot_layout(guides = "collect") & theme(legend.position = 'bottom'))
}

plot_individual_hairs <- function(i, three_hair, twofive_hair, hdia){
  three_hair_0 <- read.csv(paste0("./data/csv-files/3hair_files/hairs",i,".csv"))
  three_hair_0 <- data.frame(t(three_hair_0[,-1]))
  colnames(three_hair_0) <- c("points", "x", "y")
  twofive_hair_0 <- read.csv(paste0("./data/csv-files/25hair_files/hairs",i,".csv"))
  twofive_hair_0 <- data.frame(t(twofive_hair_0[,-1]))
  colnames(twofive_hair_0) <- c("points", "x", "y")
  ant <- circle(c(0,0), 0.5*hdia*twofive_hair$ant[i], 0.005, F)
  
  row_nums_3 <- which(grepl("^hair",colnames(three_hair)))
  row_nums_25 <- which(grepl("^hair",colnames(twofive_hair)))
  plot_col_3hairs <- data.frame(three_hair_0, 
                               "value" = as.numeric(t(three_hair[i, row_nums_3])))
  plot_col_3hairs$value <- plot_col_3hairs$value/max(plot_col_3hairs$value)
  plot_col_25hairs <- data.frame(twofive_hair_0, 
                               "value" = as.numeric(t(twofive_hair[i, row_nums_25])))
  plot_col_25hairs$value <- plot_col_25hairs$value/max(plot_col_25hairs$value)
  
  p3<- ggplot(plot_col_3hairs, aes(x,y, color = value, size = value)) + 
    geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1))+
    scale_size_binned("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1), range = c(0.25, 5)) + 
   # xlim(min(ant$x), 0.02) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color= guide_legend(), size=guide_legend(), fill = NULL) 
    
  p25<- ggplot(plot_col_25hairs, aes(x,y, color = value, size = value)) + geom_point() + 
    scale_color_viridis_b("Relative\nconcentration", breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1))+
    scale_size_binned("Relative\nconcentration",breaks = c(0.2, 0.4, 0.6, 0.8), 
                        limits = c(0,1), range = c(0.25, 5)) + 
   # xlim(min(ant$x), 0.08) + 
    coord_fixed() +
    theme_void() +
    geom_polygon(data = ant, mapping = aes(x, y), 
                 inherit.aes = FALSE, fill = "gray") +
    guides(color= guide_legend(), size=guide_legend(), fill = NULL) 
  return(p3 + p25 + plot_layout(guides = "collect") & theme(legend.position = 'bottom'))
}

plot_parameter <- function(three_dat, twofive_dat, parameter, output){
  # 3 hair
  p3 <- ggplot(three_dat, aes(.data[[parameter]], .data[[output]])) + 
    geom_point() +
    ggtitle("3 hair") + theme_minimal()
  # 25 hair
  p25 <- ggplot(twofive_dat, aes(.data[[parameter]], .data[[output]])) + 
    geom_point() + 
    ggtitle("25 hair") + theme_minimal()
  return(p3 + p25)
}

plot_values <- function(dat, variable, output, legend = TRUE){
  col_list <- grep(paste0("^",output), colnames(dat))
  col_list <- c(1:6, col_list)
  dat_sub <- dat[,col_list]
  dat_longer <- pivot_longer(dat_sub, cols = !c(1:6), names_prefix = 
                               output)
  dat_longer$name <- factor(dat_longer$name)
  num <- nlevels(dat_longer$name)
  dat_longer$name <- factor(dat_longer$name, ordered = T, levels = seq(1,num))
  p1<- ggplot(dat_longer, aes(.data[[variable]], value, fill = name,  
                              color = name)) + 
    geom_point(pch = 21, alpha = 0.5) + 
    scale_fill_viridis(discrete = T, name = "") + 
    scale_color_viridis(discrete = T, name = "") +
    ylab(output) + theme_minimal()
  if(!legend){
    p1 <- p1 + theme(legend.position = "none")
  }
  return(p1)
}
```

# Abstract


# Introduction

@Waldrop:entmodel

# Methods


# Results

## Gap-to-diameter ratio is most important for leakiness 

```{r gap-width, echo=FALSE, fig.cap="Gap width"}
plot_values(three_hair, "gap", "leakiness_row_", legend = F) +
plot_values(twofive_hair, "gap", "leakiness_row_")
```

This is true regardless of which row for the 25 hair array. Indicated by SI's. Fig. \@ref(fig:gap-width).

Reynolds number doesn't have much of an effect (Fig. \@ref(fig:re)).

```{r re, echo=FALSE, fig.cap= "Reynolds number"}
plot_values(three_hair, "angle", "leakiness_row_", legend = F) +
plot_values(twofive_hair, "angle", "leakiness_row_")
```

## Speeds around hairs is dependent on Re for most hairs, angle for some

```{r speeds-re, echo=FALSE, fig.cap="speeds, Re"}
plot_values(three_hair, "gap", "flux_hair_") +
plot_values(twofive_hair, "gap", "flux_hair_")
```

```{r speeds-angle, echo=FALSE, fig.cap="angle, Re"}
plot_values(three_hair, "angle", "Umean_hair_") +
plot_values(twofive_hair, "angle", "Umean_hair_")
```

Re is important for almost all hairs in both arrays, but relatively more important  as the hairs are closer to oncoming flow (or on the outer edges of the array). As hairs are located more inside the array, angle of the array becomes more important for driving quicker flows around the hairs. Extreme case is hair 1 (center hair in row 1) at an angle of  90$^{\circ}$) where fluid is being forced between the array and the antenna.

## 3-hair arrays capture more odor

```{r total-conc-diff, echo = FALSE, fig.cap="Total concentration and gap width"}
twofive_hair$total_conc_diff <- three_hair$total_conc/twofive_hair$total_conc
ggplot(twofive_hair, aes(gap, total_conc_diff)) + geom_point() + 
  geom_line(data = data.frame("x" = c(0,51), "y" = c(1,1)),mapping = aes(x,y), 
            color = "blue") + 
  ylab("Three-hair / twenty-five hair array ratio") + 
  theme_minimal() +
ggplot(twofive_hair, aes(angle, total_conc_diff)) + geom_point() + 
  geom_line(data = data.frame("x" = c(0,181), "y" = c(1,1)),mapping = aes(x,y), 
            color = "blue") + 
  ylab("Three-hair / twenty-five hair array ratio") + 
  theme_minimal()
```


I don't know if this is real or the result of the way the simulation was run. It's about a 55% difference, with the 3-hair array always outperforming the 25-hair array (except two simulations), which seems weird! See Fig. \@ref(fig:total-conc-diff). The difference is greatest at extreme angles and wide gap widths. 

Gap width controls much more of total concentration capture than for the 3-hair array. This is likely due to the shading effect of multiple hairs?

```{r total-conc-gap, echo = FALSE, fig.cap="Total concentration and gap width"}
plot_parameter(three_hair, twofive_hair, "gap", "total_conc") 
plot_parameter(three_hair, twofive_hair, "gap", "raw_total_conc") 
```
```{r norm-conc-gap, echo = FALSE, fig.cap="Total concentration and gap width"}
plot_parameter(three_hair, twofive_hair, "gap", "norm_conc") 
```

It looks like lower gaps lead to less leakiness, which leads to greater odor capture. 


```{r}
p3 <- ggplot(three_hair, aes(.data[["gap"]], .data[["total_conc"]], 
              color = .data[["leakiness_row_1"]])) + 
    geom_point() +
    scale_color_viridis_c()+
    ggtitle("3 hair") + theme_minimal()

p25 <- ggplot(twofive_hair, aes(.data[["gap"]], .data[["total_conc"]], 
              color = .data[["leakiness_row_1"]])) + 
    geom_point() +
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()

p3 / p25
```



```{r gap-angle-norm-conc-map, echo = FALSE, fig.height=5*1.5, fig.width=5}
p3 <- ggplot(three_hair[order(three_hair$norm_conc),], aes(.data[["gap"]], .data[["angle"]], 
              color = .data[["norm_conc"]], size = .data[["norm_conc"]])) + 
  geom_point() +
  scale_color_viridis_b("Normalized\nconcentration", breaks = seq(0,0.15, by = 0.025), 
                        limits = c(0,0.15))+
  scale_size_binned("Normalized\nconcentration", breaks = seq(0,0.15, by = 0.025), 
                    range = c(0.5, 4), limits = c(0,0.15)) + 
  ggtitle("3-hair array") + theme_minimal() +
  guides(color= guide_legend(), size=guide_legend()) 


p25 <- ggplot(twofive_hair[order(twofive_hair$norm_conc),], aes(.data[["gap"]], .data[["angle"]], 
              color = .data[["norm_conc"]], size = .data[["norm_conc"]])) + 
  geom_point() +
  scale_color_viridis_b("Normalized\nconcentration", breaks = seq(0,0.15, by = 0.025), 
                        limits = c(0,0.15))+
  scale_size_binned("Normalized\nconcentration", breaks = seq(0,0.15, by = 0.025), 
                    range = c(0.5, 4), limits = c(0,0.15)) + 
  ggtitle("25-hair array") + theme_minimal() + 
  guides(color= guide_legend(), size=guide_legend()) 

(p3 / p25) + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
```

```{r, echo=FALSE, fig.cap=" "}

plot_values(twofive_hair, "angle", "hair")
```

```{r}
p3 <- ggplot(three_hair, aes(.data[["leakiness_row_1"]], .data[["total_conc"]], 
              color = .data[["angle"]])) + 
    geom_point() +
    scale_color_viridis_c()+
    ggtitle("3 hair") + theme_minimal()

p25 <- ggplot(twofive_hair, aes(.data[["leakiness_row_5"]], .data[["total_conc"]], 
              color = .data[["angle"]])) + 
    geom_point() +
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()

p3 / p25
```

```{r}
var1 <- "angle"
x_range <- c(0, max(twofive_hair$leakiness_row_1))
y_range <- c(0, max(twofive_hair$row5))

p25 <- ggplot(twofive_hair, aes(.data[["leakiness_row_1"]], .data[["row1"]],
                                color = .data[[var1]])) + 
    geom_point() +
    ylim(y_range) + xlim(x_range) + 
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()

p25_2 <- ggplot(twofive_hair, aes(.data[["leakiness_row_2"]], .data[["row2"]],
                                  color = .data[[var1]])) + 
    geom_point() +
    ylim(y_range) + xlim(x_range) + 
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()

p25_3 <- ggplot(twofive_hair, aes(.data[["leakiness_row_3"]], .data[["row3"]],
                                  color = .data[[var1]])) + 
    geom_point() +
    ylim(y_range) + xlim(x_range) + 
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()

p25_4 <- ggplot(twofive_hair, aes(.data[["leakiness_row_4"]], .data[["row4"]],
                                  color = .data[[var1]])) + 
    geom_point() +
    ylim(y_range) + xlim(x_range) + 
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()

p25_5 <- ggplot(twofive_hair, aes(.data[["leakiness_row_5"]], .data[["row5"]],
                                  color = .data[[var1]])) + 
    geom_point() +
    ylim(y_range) + xlim(x_range) + 
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()
p25 /p25_2 /p25_3 / p25_4 / p25_5
```

```{r}
var1 <- "angle"
x_range <- c(0, max(twofive_hair$leakiness_row_1))
y_range <- c(0, max(twofive_hair$row5))


p25 <- ggplot(three_hair, aes(.data[["leakiness_row_1"]], .data[["row1"]],
                                color = .data[[var1]])) + 
    geom_point() +
    ylim(y_range) + xlim(x_range) + 
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()

p25_2 <- ggplot(twofive_hair, aes(.data[["leakiness_row_2"]], .data[["row2"]],
                                  color = .data[[var1]])) + 
    geom_point() +
    ylim(y_range) + xlim(x_range) + 
    scale_color_continuous(type = "viridis") +
    ggtitle("25 hair") + theme_minimal()
```


```{r}

```


# Discussion


# Conclusions


# References

